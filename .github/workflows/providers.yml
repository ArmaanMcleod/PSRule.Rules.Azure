name: BumpProviders

on:
  schedule:
    - cron:  '0 */6 * * *'
  workflow_dispatch:

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup GIT user
        uses: fregante/setup-git-user@v1

      - name: Build
        uses: Amadevus/pwsh-script@v2.0.1
        with:
          script: ./build.ps1

      - name: Azure Login
        uses: Azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true

      - name: Bump Providers
        uses: Azure/powershell@v1
        with:
          inlineScript: |
            Invoke-Build ExportProviders
            $changedFiles = git diff --name-only
            if ($changedFiles -eq 'data/providers.json') {
              git checkout -b bump-providers
              git add data/providers.json
              git commit -m 'Updated providers'
              git push origin bump-providers
              gh pr create --base 'main' --head 'bump-providers' --title 'Bump Providers data' --repo 'ArmaanMcleod/PSRule.Rules.Azure'
            }
            else {
              Write-Host 'Providers data up to date!'
            }
          azPSVersion: latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}